<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Docsync Preview</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #334155; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 300px; background: #fff; border-right: 1px solid #e2e8f0; flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar-header { padding: 16px 20px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; }
        .logo { width: 32px; height: 32px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .logo svg { width: 18px; height: 18px; fill: white; }
        .sidebar-header h1 { font-size: 15px; font-weight: 600; color: #1e293b; }
        .sidebar-controls { padding: 12px 16px; border-bottom: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 10px; }
        .search-box input { width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px; outline: none; transition: border-color 0.15s; }
        .search-box input:focus { border-color: #3b82f6; }
        .view-toggle { display: flex; background: #f1f5f9; border-radius: 6px; padding: 3px; }
        .view-toggle-btn { flex: 1; padding: 6px 12px; font-size: 12px; font-weight: 500; color: #64748b; background: none; border: none; border-radius: 4px; cursor: pointer; transition: all 0.15s; }
        .view-toggle-btn:hover { color: #475569; }
        .view-toggle-btn.active { background: #fff; color: #1e293b; box-shadow: 0 1px 2px rgba(0,0,0,0.08); }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 8px; }
        .list-view { display: none; }
        .list-view.active { display: block; }
        .tree-item { display: flex; align-items: center; padding: 6px 8px; border-radius: 6px; cursor: pointer; font-size: 13px; color: #475569; }
        .tree-item:hover { background: #f1f5f9; }
        .tree-item.active { background: #dbeafe; color: #1e40af; }
        .tree-item.folder { font-weight: 500; color: #1e293b; }
        .tree-indent { width: 16px; flex-shrink: 0; }
        .tree-icon { width: 16px; height: 16px; margin-right: 8px; flex-shrink: 0; color: #94a3b8; }
        .tree-item.folder .tree-icon { color: #f59e0b; }
        .tree-item.folder .tree-chevron { width: 12px; height: 12px; margin-right: 4px; color: #94a3b8; transition: transform 0.15s; flex-shrink: 0; }
        .tree-item.folder.collapsed .tree-chevron { transform: rotate(-90deg); }
        .tree-children { display: block; }
        .tree-children.collapsed { display: none; }
        .tree-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .level-item { padding: 8px 12px 8px 24px; border-radius: 6px; cursor: pointer; margin-bottom: 4px; }
        .level-item:hover { background: #f1f5f9; }
        .level-item.active { background: #dbeafe; }
        .level-item-name { font-size: 13px; font-weight: 500; color: #1e293b; margin-bottom: 2px; }
        .level-item-path { font-size: 11px; color: #94a3b8; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .level-group { margin-bottom: 12px; }
        .level-title { font-size: 11px; font-weight: 600; color: #94a3b8; padding: 4px 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; border-radius: 4px; }
        .level-title:hover { background: #f1f5f9; }
        .level-title .level-chevron { width: 12px; height: 12px; color: #94a3b8; transition: transform 0.15s; flex-shrink: 0; }
        .level-title.collapsed .level-chevron { transform: rotate(-90deg); }
        .level-items { display: block; }
        .level-items.collapsed { display: none; }
        .level-dot { width: 8px; height: 8px; border-radius: 2px; }
        .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .main-header { padding: 12px 24px; background: #fff; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; }
        .main-header h2 { font-size: 15px; font-weight: 600; color: #1e293b; }
        .header-stats { font-size: 12px; color: #64748b; display: flex; gap: 16px; }
        .header-stats span { display: flex; align-items: center; gap: 4px; }
        .main-toggle { display: flex; background: #f1f5f9; border-radius: 6px; padding: 3px; }
        .main-toggle-btn { padding: 6px 14px; font-size: 12px; font-weight: 500; color: #64748b; background: none; border: none; border-radius: 4px; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 6px; }
        .main-toggle-btn:hover { color: #475569; }
        .main-toggle-btn.active { background: #fff; color: #1e293b; box-shadow: 0 1px 2px rgba(0,0,0,0.08); }
        .main-toggle-btn svg { width: 14px; height: 14px; }
        .main-content { flex: 1; overflow: auto; padding: 24px; background: #f1f5f9; }
        .graph-container { background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); min-height: 100%; }
        .graph-container svg { max-width: 100%; height: auto; }
        .doc-container { background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); padding: 48px; max-width: 900px; margin: 0 auto; display: none; }
        .doc-container.visible { display: block; }
        .doc-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; color: #94a3b8; }
        .doc-empty svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5; }
        .doc-empty p { font-size: 14px; }
        .graph-wrapper.hidden { display: none; }
        .doc-path { font-size: 12px; color: #94a3b8; margin-bottom: 24px; padding: 8px 12px; background: #f8fafc; border-radius: 6px; font-family: 'SF Mono', Monaco, monospace; }
        .doc-content { line-height: 1.7; }
        .doc-content h1 { font-size: 32px; font-weight: 700; margin-bottom: 16px; color: #1e293b; }
        .doc-content h2 { font-size: 24px; font-weight: 600; margin-top: 40px; margin-bottom: 16px; color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
        .doc-content h3 { font-size: 18px; font-weight: 600; margin-top: 32px; margin-bottom: 12px; color: #334155; }
        .doc-content p { margin-bottom: 16px; color: #475569; }
        .doc-content ul, .doc-content ol { margin-bottom: 16px; padding-left: 24px; color: #475569; }
        .doc-content li { margin-bottom: 8px; }
        .doc-content code { background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; font-family: 'SF Mono', Monaco, monospace; color: #e11d48; }
        .doc-content pre { background: #1e293b; color: #e2e8f0; padding: 20px; border-radius: 8px; overflow-x: auto; margin-bottom: 20px; }
        .doc-content pre code { background: none; padding: 0; color: inherit; }
        .doc-content table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .doc-content th, .doc-content td { border: 1px solid #e2e8f0; padding: 12px; text-align: left; }
        .doc-content th { background: #f8fafc; font-weight: 600; color: #1e293b; }
        .doc-content a { color: #3b82f6; text-decoration: none; }
        .doc-content a:hover { text-decoration: underline; }
        .node { cursor: pointer; transition: opacity 0.2s; }
        .flowchart-link { transition: opacity 0.2s; }
        .doc-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
        .doc-header .doc-path { margin-bottom: 0; flex: 1; }
        .doc-actions { display: flex; gap: 8px; margin-left: 16px; }
        .doc-btn { padding: 6px 12px; font-size: 12px; font-weight: 500; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.15s; }
        .doc-btn svg { width: 14px; height: 14px; }
        .doc-btn-edit { color: #3b82f6; background: #eff6ff; }
        .doc-btn-edit:hover { background: #dbeafe; }
        .doc-btn-save { color: #fff; background: #22c55e; }
        .doc-btn-save:hover { background: #16a34a; }
        .doc-btn-cancel { color: #64748b; background: #f1f5f9; }
        .doc-btn-cancel:hover { background: #e2e8f0; }
        .doc-editor { width: 100%; min-height: 400px; padding: 16px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: 'SF Mono', Monaco, monospace; font-size: 14px; line-height: 1.6; resize: vertical; outline: none; }
        .doc-editor:focus { border-color: #3b82f6; }
        .doc-view { display: block; }
        .doc-view.hidden { display: none; }
        .doc-edit { display: none; }
        .doc-edit.visible { display: block; }
        .doc-wrapper { display: flex; gap: 24px; }
        .doc-main { flex: 1; min-width: 0; }
        .doc-history { width: 280px; flex-shrink: 0; }
        .history-panel { background: #f8fafc; border-radius: 8px; padding: 16px; position: sticky; top: 0; }
        .history-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .history-title { font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .history-toggle { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #64748b; cursor: pointer; }
        .history-toggle input { cursor: pointer; }
        .history-list { display: flex; flex-direction: column; gap: 4px; max-height: 400px; overflow-y: auto; }
        .history-item { padding: 10px 12px; background: #fff; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: all 0.15s; }
        .history-item:hover { border-color: #e2e8f0; }
        .history-item.active { border-color: #3b82f6; background: #eff6ff; }
        .history-item.current { border-color: #22c55e; }
        .history-item-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .history-hash { font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: #8b5cf6; background: #f3e8ff; padding: 2px 6px; border-radius: 4px; }
        .history-date { font-size: 11px; color: #94a3b8; }
        .history-message { font-size: 12px; color: #334155; line-height: 1.4; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .history-author { font-size: 11px; color: #94a3b8; margin-top: 4px; }
        .history-current-badge { font-size: 10px; color: #22c55e; background: #dcfce7; padding: 2px 6px; border-radius: 4px; margin-left: auto; }
        .diff-add { background: #dcfce7; border-left: 3px solid #22c55e; padding-left: 8px; margin-left: -11px; }
        .diff-del { background: #fee2e2; border-left: 3px solid #ef4444; padding-left: 8px; margin-left: -11px; opacity: 0.7; }
        .diff-section { margin-bottom: 16px; padding: 12px; border-radius: 6px; }
        .diff-section.additions { background: #f0fdf4; border: 1px solid #bbf7d0; }
        .diff-section.deletions { background: #fef2f2; border: 1px solid #fecaca; }
        .diff-section-title { font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
        .diff-section.additions .diff-section-title { color: #16a34a; }
        .diff-section.deletions .diff-section-title { color: #dc2626; }
        .diff-line { font-family: 'SF Mono', Monaco, monospace; font-size: 12px; line-height: 1.6; white-space: pre-wrap; }
        .doc-diff-summary { margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e2e8f0; }
        .search-results { display: none; }
        .search-title { font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 12px; }
        .search-empty { color: #94a3b8; font-size: 13px; text-align: center; padding: 24px; }
        .search-result { padding: 10px 12px; border-radius: 6px; cursor: pointer; margin-bottom: 4px; background: #fff; border: 1px solid #e2e8f0; }
        .search-result:hover { border-color: #3b82f6; }
        .search-result-name { font-size: 13px; font-weight: 500; color: #1e293b; margin-bottom: 2px; }
        .search-result-path { font-size: 11px; color: #94a3b8; margin-bottom: 6px; }
        .search-result-match { font-size: 11px; color: #64748b; font-family: 'SF Mono', Monaco, monospace; background: #f8fafc; padding: 4px 8px; border-radius: 4px; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .graph-wrapper { position: relative; min-height: 100%; }
        .graph-export-btn { position: absolute; top: 12px; right: 12px; padding: 8px; background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; color: #64748b; z-index: 10; }
        .graph-export-btn:hover { background: #f1f5f9; color: #3b82f6; border-color: #3b82f6; }
        .graph-export-btn svg { width: 16px; height: 16px; display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo" id="logo-btn" title="Back to graph">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                </div>
                <h1>Docsync Preview</h1>
            </div>
            <div class="sidebar-controls">
                <div class="search-box">
                    <input type="text" placeholder="Search docs..." id="search-input">
                </div>
                <div class="view-toggle">
                    <button class="view-toggle-btn active" data-view="tree">Folder Tree</button>
                    <button class="view-toggle-btn" data-view="levels">By Level</button>
                </div>
            </div>
            <div class="sidebar-content">
                <div class="list-view active" id="folder-tree"></div>
                <div class="list-view" id="level-list"></div>
            </div>
        </div>
        <div class="main">
            <div class="main-header">
                <div style="display:flex;align-items:center;gap:16px;">
                    <div class="main-toggle">
                        <button class="main-toggle-btn active" data-main-view="diagram">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="12" x2="6" y2="16"></line><line x1="12" y1="12" x2="18" y2="16"></line><circle cx="6" cy="19" r="3"></circle><circle cx="18" cy="19" r="3"></circle></svg>
                            Diagram
                        </button>
                        <button class="main-toggle-btn" data-main-view="editor">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                            Editor
                        </button>
                    </div>
                    <h2 id="page-title">Dependency Graph</h2>
                </div>
                <div class="header-stats">
                    <span id="stat-total"></span>
                    <span id="stat-independent"></span>
                    <span id="stat-depth"></span>
                    <span id="stat-circular"></span>
                </div>
                            </div>
            <div class="main-content">
                <div class="graph-wrapper" id="graph-wrapper">
                    <button class="graph-export-btn" onclick="exportSVG()" title="Download SVG">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    </button>
                    <div class="graph-container" id="graph"></div>
                </div>
                <div class="doc-container" id="doc-container"></div>
            </div>
        </div>
    </div>
    <script>
        const graphData = "__GRAPH_DATA__";
        const levelColors = ['#22c55e', '#3b82f6', '#f59e0b', '#ec4899', '#a855f7', '#06b6d4'];
        let currentDoc = null;
        let selectedNode = null;
        let edgeElements = [];
        let currentListView = 'tree';
        let currentMainView = 'diagram';
        let autoSelectedDoc = false;

        function switchListView(view) {
            currentListView = view;
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            document.getElementById('folder-tree').classList.toggle('active', view === 'tree');
            document.getElementById('level-list').classList.toggle('active', view === 'levels');
        }

        document.querySelectorAll('.view-toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => switchListView(btn.dataset.view));
        });

        function switchMainView(view) {
            currentMainView = view;
            document.querySelectorAll('.main-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mainView === view);
            });
            document.getElementById('graph-wrapper').classList.toggle('hidden', view !== 'diagram');
            document.getElementById('doc-container').classList.toggle('visible', view === 'editor');
            if (view === 'diagram') {
                document.getElementById('page-title').textContent = 'Dependency Graph';
                if (autoSelectedDoc) {
                    currentDoc = null;
                    updateSidebarSelection(null);
                    resetHighlight();
                    autoSelectedDoc = false;
                }
            } else if (view === 'editor') {
                if (currentDoc) {
                    loadDocContent(currentDoc);
                } else if (graphData.nodes.length > 0) {
                    const firstDoc = document.querySelector('.tree-item:not(.folder)');
                    if (firstDoc && firstDoc.dataset.path) {
                        selectDoc(firstDoc.dataset.path, true);
                    } else {
                        selectDoc(graphData.nodes[0].path, true);
                    }
                } else {
                    showEmptyEditor();
                }
            }
        }

        function showEmptyEditor() {
            const container = document.getElementById('doc-container');
            container.innerHTML = '<div class="doc-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg><p>Select a document from the sidebar</p></div>';
            document.getElementById('page-title').textContent = 'Editor';
        }

        document.querySelectorAll('.main-toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => switchMainView(btn.dataset.mainView));
        });

        function updateSidebarSelection(path) {
            document.querySelectorAll('.tree-item, .level-item').forEach(el => {
                el.classList.toggle('active', el.dataset.path === path);
            });
            const activeItem = document.querySelector('.tree-item.active, .level-item.active');
            if (activeItem) activeItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }

        function selectDoc(path, isAuto = false) {
            currentDoc = path;
            autoSelectedDoc = isAuto;
            updateSidebarSelection(path);
            if (currentMainView === 'diagram') {
                const node = graphData.nodes.find(n => n.path === path);
                if (node) highlightNode(node.id, true);
            } else {
                loadDocContent(path);
            }
        }

        let originalContent = '';
        let isEditing = false;
        let docHistory = [];
        let currentCommit = null;
        let previousContent = null;
        let highlightChanges = false;
        let lastCommitDiff = '';

        async function loadDocContent(path) {
            const container = document.getElementById('doc-container');
            container.innerHTML = '<div style="color:#94a3b8;text-align:center;padding:40px">Loading...</div>';
            isEditing = false;
            currentCommit = null;
            previousContent = null;
            lastCommitDiff = '';
            try {
                const [docRes, historyRes] = await Promise.all([
                    fetch('/doc?path=' + encodeURIComponent(path)),
                    fetch('/history?path=' + encodeURIComponent(path))
                ]);
                if (!docRes.ok) throw new Error('Failed to load');
                const md = await docRes.text();
                originalContent = md;
                docHistory = historyRes.ok ? await historyRes.json() : [];
                if (highlightChanges && docHistory.length > 0) {
                    const prevRes = await fetch('/doc?path=' + encodeURIComponent(path) + '&commit=' + docHistory[0].hash);
                    previousContent = prevRes.ok ? await prevRes.text() : null;
                    if (docHistory.length > 1) {
                        const [commit0Res, commit1Res] = await Promise.all([
                            fetch('/doc?path=' + encodeURIComponent(path) + '&commit=' + docHistory[0].hash),
                            fetch('/doc?path=' + encodeURIComponent(path) + '&commit=' + docHistory[1].hash)
                        ]);
                        if (commit0Res.ok && commit1Res.ok) {
                            const commit0Content = await commit0Res.text();
                            const commit1Content = await commit1Res.text();
                            lastCommitDiff = generateDiffSummary(commit1Content, commit0Content);
                        }
                    }
                }
                renderDocView(path, md);
                const node = graphData.nodes.find(n => n.path === path);
                document.getElementById('page-title').textContent = node ? node.name : path.split('/').pop();
            } catch (e) {
                container.innerHTML = '<div style="color:#ef4444;text-align:center;padding:40px">Failed to load document</div>';
            }
        }

        function renderDocView(path, md) {
            const container = document.getElementById('doc-container');
            const html = marked.parse(md);
            const isOldVersion = currentCommit !== null;
            let diffSummary = '';
            if (highlightChanges && previousContent !== null) {
                const { added, removed } = computeDiff(previousContent, md);
                if (added.length === 0 && removed.length === 0 && !isOldVersion && docHistory.length > 0) {
                    diffSummary = '<div style="color:#94a3b8;font-size:13px;padding:12px;text-align:center;background:#f8fafc;border-radius:6px;margin-bottom:16px">No uncommitted changes. Showing last commit changes below.</div>' + (lastCommitDiff || '');
                } else {
                    diffSummary = generateDiffSummary(previousContent, md);
                }
            }
            container.innerHTML = `
                <div class="doc-wrapper">
                    <div class="doc-main">
                        <div class="doc-header">
                            <div class="doc-path">${path}${isOldVersion ? ' @ ' + currentCommit.substring(0, 7) : ''}</div>
                            <div class="doc-actions">
                                ${isOldVersion ? `
                                    <button class="doc-btn doc-btn-cancel" onclick="loadCurrentVersion()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                                        Back to current
                                    </button>
                                ` : `
                                    <button class="doc-btn doc-btn-edit" onclick="enterEditMode()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                        Edit
                                    </button>
                                `}
                            </div>
                        </div>
                        <div class="doc-view">
                            ${diffSummary ? '<div class="doc-diff-summary">' + diffSummary + '</div>' : ''}
                            <div class="doc-content">${html}</div>
                        </div>
                        <div class="doc-edit">
                            <textarea class="doc-editor" id="doc-editor">${escapeHtml(md)}</textarea>
                        </div>
                    </div>
                    <div class="doc-history">
                        <div class="history-panel">
                            <div class="history-header">
                                <span class="history-title">History</span>
                                <label class="history-toggle">
                                    <input type="checkbox" id="highlight-toggle" ${highlightChanges ? 'checked' : ''} onchange="toggleHighlight()">
                                    Show changes
                                </label>
                            </div>
                            <div class="history-list" id="history-list"></div>
                        </div>
                    </div>
                </div>
            `;
            renderHistoryList();
        }

        function renderHistoryList() {
            const list = document.getElementById('history-list');
            if (!list) return;
            if (docHistory.length === 0) {
                list.innerHTML = '<div style="color:#94a3b8;font-size:12px;text-align:center;padding:16px">No history available</div>';
                return;
            }
            list.innerHTML = `
                <div class="history-item ${currentCommit === null ? 'active current' : 'current'}" onclick="loadCurrentVersion()">
                    <div class="history-item-header">
                        <span class="history-hash">current</span>
                        <span class="history-current-badge">Latest</span>
                    </div>
                    <div class="history-message">Working copy</div>
                </div>
            ` + docHistory.map((commit, i) => `
                <div class="history-item ${currentCommit === commit.hash ? 'active' : ''}" onclick="loadVersion('${commit.hash}', ${i})">
                    <div class="history-item-header">
                        <span class="history-hash">${commit.short}</span>
                        <span class="history-date">${formatDate(commit.date)}</span>
                    </div>
                    <div class="history-message">${escapeHtml(commit.message)}</div>
                    <div class="history-author">${escapeHtml(commit.author)}</div>
                </div>
            `).join('');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return days + 'd ago';
            if (days < 30) return Math.floor(days / 7) + 'w ago';
            return date.toLocaleDateString();
        }

        async function loadVersion(hash, index) {
            currentCommit = hash;
            try {
                const res = await fetch('/doc?path=' + encodeURIComponent(currentDoc) + '&commit=' + hash);
                if (!res.ok) throw new Error('Failed to load version');
                const md = await res.text();
                if (highlightChanges && index < docHistory.length - 1) {
                    const prevRes = await fetch('/doc?path=' + encodeURIComponent(currentDoc) + '&commit=' + docHistory[index + 1].hash);
                    previousContent = prevRes.ok ? await prevRes.text() : null;
                } else {
                    previousContent = null;
                }
                renderDocView(currentDoc, md);
            } catch (e) {
                alert('Failed to load version');
            }
        }

        async function loadCurrentVersion() {
            currentCommit = null;
            lastCommitDiff = '';
            if (highlightChanges && docHistory.length > 0) {
                const prevRes = await fetch('/doc?path=' + encodeURIComponent(currentDoc) + '&commit=' + docHistory[0].hash);
                previousContent = prevRes.ok ? await prevRes.text() : null;
                if (docHistory.length > 1) {
                    const [commit0Res, commit1Res] = await Promise.all([
                        fetch('/doc?path=' + encodeURIComponent(currentDoc) + '&commit=' + docHistory[0].hash),
                        fetch('/doc?path=' + encodeURIComponent(currentDoc) + '&commit=' + docHistory[1].hash)
                    ]);
                    if (commit0Res.ok && commit1Res.ok) {
                        const commit0Content = await commit0Res.text();
                        const commit1Content = await commit1Res.text();
                        lastCommitDiff = generateDiffSummary(commit1Content, commit0Content);
                    }
                }
            } else {
                previousContent = null;
            }
            renderDocView(currentDoc, originalContent);
        }

        async function toggleHighlight() {
            highlightChanges = document.getElementById('highlight-toggle').checked;
            if (currentCommit) {
                const index = docHistory.findIndex(c => c.hash === currentCommit);
                loadVersion(currentCommit, index);
            } else {
                await loadCurrentVersion();
            }
        }

        function computeDiff(oldText, newText) {
            const oldLines = oldText.split('\n');
            const newLines = newText.split('\n');
            const oldSet = new Set(oldLines);
            const newSet = new Set(newLines);
            const added = newLines.filter(l => l.trim() && !oldSet.has(l));
            const removed = oldLines.filter(l => l.trim() && !newSet.has(l));
            return { added, removed };
        }

        function generateDiffSummary(oldText, newText) {
            const { added, removed } = computeDiff(oldText, newText);
            if (added.length === 0 && removed.length === 0) {
                return '<div style="color:#94a3b8;font-size:13px;padding:16px;text-align:center">No changes detected</div>';
            }
            let html = '';
            if (added.length > 0) {
                html += `<div class="diff-section additions">
                    <div class="diff-section-title">+ ${added.length} line${added.length > 1 ? 's' : ''} added</div>
                    ${added.map(l => '<div class="diff-line">' + escapeHtml(l) + '</div>').join('')}
                </div>`;
            }
            if (removed.length > 0) {
                html += `<div class="diff-section deletions">
                    <div class="diff-section-title">- ${removed.length} line${removed.length > 1 ? 's' : ''} removed</div>
                    ${removed.map(l => '<div class="diff-line">' + escapeHtml(l) + '</div>').join('')}
                </div>`;
            }
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function enterEditMode() {
            isEditing = true;
            document.querySelector('.doc-view').classList.add('hidden');
            document.querySelector('.doc-edit').classList.add('visible');
            document.querySelector('.doc-history').style.display = 'none';
            document.querySelector('.doc-actions').innerHTML = `
                <button class="doc-btn doc-btn-cancel" onclick="cancelEdit()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    Cancel
                </button>
                <button class="doc-btn doc-btn-save" onclick="saveDoc()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Save
                </button>
            `;
        }

        function cancelEdit() {
            isEditing = false;
            document.getElementById('doc-editor').value = originalContent;
            document.querySelector('.doc-history').style.display = '';
            document.querySelector('.doc-view').classList.remove('hidden');
            document.querySelector('.doc-edit').classList.remove('visible');
            document.querySelector('.doc-actions').innerHTML = `
                <button class="doc-btn doc-btn-edit" onclick="enterEditMode()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    Edit
                </button>
            `;
        }

        async function saveDoc() {
            const editor = document.getElementById('doc-editor');
            const newContent = editor.value;
            try {
                const res = await fetch('/doc?path=' + encodeURIComponent(currentDoc), {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain; charset=utf-8' },
                    body: newContent
                });
                if (!res.ok) throw new Error('Failed to save');
                originalContent = newContent;
                const html = marked.parse(newContent);
                document.querySelector('.doc-content').innerHTML = html;
                cancelEdit();
            } catch (e) {
                alert('Failed to save document');
            }
        }

        function buildFolderTree() {
            const container = document.getElementById('folder-tree');
            const tree = {};
            graphData.nodes.forEach(n => {
                const parts = n.path.split('/');
                let current = tree;
                parts.forEach((part, i) => {
                    if (!current[part]) {
                        current[part] = i === parts.length - 1 ? { __file: n } : {};
                    }
                    current = current[part];
                });
            });
            function renderTree(obj, depth = 0) {
                const fragment = document.createDocumentFragment();
                const entries = Object.entries(obj).filter(([k]) => k !== '__file').sort((a, b) => {
                    const aIsFile = !!a[1].__file;
                    const bIsFile = !!b[1].__file;
                    if (aIsFile !== bIsFile) return aIsFile ? 1 : -1;
                    return a[0].localeCompare(b[0]);
                });
                entries.forEach(([name, value]) => {
                    const isFile = !!value.__file;
                    const item = document.createElement('div');
                    item.className = 'tree-item' + (isFile ? '' : ' folder');
                    if (isFile) item.dataset.path = value.__file.path;
                    let indent = '';
                    for (let i = 0; i < depth; i++) indent += '<span class="tree-indent"></span>';
                    const chevron = '<svg class="tree-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    const icon = isFile
                        ? '<svg class="tree-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>'
                        : '<svg class="tree-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>';
                    item.innerHTML = indent + (isFile ? '' : chevron) + icon + '<span class="tree-name">' + name + '</span>';
                    if (isFile) {
                        item.addEventListener('click', () => selectDoc(value.__file.path));
                    }
                    fragment.appendChild(item);
                    if (!isFile) {
                        const children = document.createElement('div');
                        children.className = 'tree-children';
                        children.appendChild(renderTree(value, depth + 1));
                        fragment.appendChild(children);
                        item.addEventListener('click', () => {
                            item.classList.toggle('collapsed');
                            children.classList.toggle('collapsed');
                        });
                    }
                });
                return fragment;
            }
            container.appendChild(renderTree(tree));
        }

        function buildLevelList() {
            const container = document.getElementById('level-list');
            const levelGroups = {};
            graphData.nodes.forEach(n => {
                if (!levelGroups[n.level]) levelGroups[n.level] = [];
                levelGroups[n.level].push(n);
            });
            Object.keys(levelGroups).sort((a, b) => a - b).forEach(level => {
                const group = document.createElement('div');
                group.className = 'level-group';
                const title = document.createElement('div');
                title.className = 'level-title';
                const color = levelColors[level % levelColors.length];
                const label = level == 0 ? 'Independent' : 'Level ' + level;
                const chevron = '<svg class="level-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                title.innerHTML = chevron + '<span class="level-dot" style="background:' + color + '"></span>' + label + ' (' + levelGroups[level].length + ')';
                group.appendChild(title);
                const items = document.createElement('div');
                items.className = 'level-items';
                levelGroups[level].sort((a, b) => a.name.localeCompare(b.name)).forEach(n => {
                    const item = document.createElement('div');
                    item.className = 'level-item';
                    item.dataset.path = n.path;
                    item.innerHTML = '<div class="level-item-name">' + n.name + '</div><div class="level-item-path">' + n.path + '</div>';
                    item.addEventListener('click', () => selectDoc(n.path));
                    items.appendChild(item);
                });
                group.appendChild(items);
                title.addEventListener('click', () => {
                    title.classList.toggle('collapsed');
                    items.classList.toggle('collapsed');
                });
                container.appendChild(group);
            });
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = 'Total: ' + graphData.stats.total;
            document.getElementById('stat-independent').textContent = 'Independent: ' + graphData.stats.independent;
            document.getElementById('stat-depth').textContent = 'Depth: ' + graphData.stats.max_depth;
            if (graphData.stats.circular > 0) {
                document.getElementById('stat-circular').textContent = 'Circular: ' + graphData.stats.circular;
                document.getElementById('stat-circular').style.color = '#f59e0b';
            }
        }

        let searchTimeout = null;
        const searchResultsContainer = document.createElement('div');
        searchResultsContainer.id = 'search-results';
        searchResultsContainer.className = 'search-results';
        document.querySelector('.sidebar-content').prepend(searchResultsContainer);

        document.getElementById('search-input').addEventListener('input', (e) => {
            const q = e.target.value.trim();
            clearTimeout(searchTimeout);
            if (q.length === 0) {
                searchResultsContainer.style.display = 'none';
                document.getElementById('folder-tree').style.display = '';
                document.getElementById('level-list').style.display = '';
                switchListView(currentListView);
                return;
            }
            if (q.length < 3) {
                searchResultsContainer.style.display = 'none';
                document.getElementById('folder-tree').style.display = currentListView === 'tree' ? '' : 'none';
                document.getElementById('level-list').style.display = currentListView === 'levels' ? '' : 'none';
                const qLower = q.toLowerCase();
                document.querySelectorAll('.tree-item:not(.folder)').forEach(item => {
                    const name = item.querySelector('.tree-name').textContent.toLowerCase();
                    item.style.display = name.includes(qLower) ? '' : 'none';
                });
                document.querySelectorAll('.level-item').forEach(item => {
                    const name = item.querySelector('.level-item-name').textContent.toLowerCase();
                    item.style.display = name.includes(qLower) ? '' : 'none';
                });
                return;
            }
            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch('/search?q=' + encodeURIComponent(q));
                    const results = await res.json();
                    document.getElementById('folder-tree').style.display = 'none';
                    document.getElementById('level-list').style.display = 'none';
                    searchResultsContainer.style.display = 'block';
                    if (results.length === 0) {
                        searchResultsContainer.innerHTML = '<div class="search-empty">No results found</div>';
                    } else {
                        searchResultsContainer.innerHTML = '<div class="search-title">Search Results (' + results.length + ')</div>' +
                            results.map(r => `
                                <div class="search-result" onclick="selectDoc('${r.path}')">
                                    <div class="search-result-name">${escapeHtml(r.name)}</div>
                                    <div class="search-result-path">${escapeHtml(r.path)}</div>
                                    ${r.matches.map(m => `<div class="search-result-match">L${m.line}: ${escapeHtml(m.text)}</div>`).join('')}
                                </div>
                            `).join('');
                    }
                } catch (e) {}
            }, 300);
        });

        document.getElementById('logo-btn').addEventListener('click', () => switchMainView('diagram'));

        function buildMermaidDef() {
            let lines = ['flowchart TB'];
            const levelGroups = {};
            graphData.nodes.forEach(n => {
                if (!levelGroups[n.level]) levelGroups[n.level] = [];
                levelGroups[n.level].push(n);
            });
            Object.keys(levelGroups).sort((a, b) => a - b).forEach(level => {
                const nodes = levelGroups[level];
                const label = level == 0 ? 'Independent' : 'Level ' + level;
                const color = levelColors[level % levelColors.length];
                lines.push('    subgraph L' + level + '[' + label + ']');
                lines.push('        style L' + level + ' fill:#fff,stroke:' + color + ',stroke-width:2px');
                nodes.forEach(n => {
                    lines.push('        ' + n.id + '["' + n.name + '"]');
                });
                lines.push('    end');
            });
            graphData.edges.forEach(e => {
                if (e.circular) {
                    lines.push('    ' + e.from + ' -.->|circular| ' + e.to);
                } else {
                    lines.push('    ' + e.from + ' --> ' + e.to);
                }
            });
            graphData.nodes.forEach(n => {
                const color = levelColors[n.level % levelColors.length];
                lines.push('    style ' + n.id + ' fill:' + color + ',stroke:' + color + ',color:#fff');
            });
            return lines.join('\n');
        }

        function indexEdges() {
            edgeElements = Array.from(document.querySelectorAll('.flowchart-link'));
        }

        function getConnectedNodes(nodeId) {
            const connected = new Set([nodeId]);
            graphData.edges.forEach(e => {
                if (e.from === nodeId) connected.add(e.to);
                if (e.to === nodeId) connected.add(e.from);
            });
            return connected;
        }

        function getConnectedEdgeIndices(nodeId) {
            const indices = [];
            graphData.edges.forEach((e, i) => {
                if (e.from === nodeId || e.to === nodeId) indices.push(i);
            });
            return indices;
        }

        function highlightNode(nodeId, fromSidebar = false) {
            if (selectedNode === nodeId) {
                resetHighlight();
                return;
            }
            selectedNode = nodeId;
            if (!fromSidebar) {
                const node = graphData.nodes.find(n => n.id === nodeId);
                if (node) {
                    currentDoc = node.path;
                    updateSidebarSelection(node.path);
                }
            }
            const connected = getConnectedNodes(nodeId);
            const connectedEdgeIndices = new Set(getConnectedEdgeIndices(nodeId));
            document.querySelectorAll('.node').forEach(el => {
                const id = el.id.split('-')[1];
                el.style.opacity = connected.has(id) ? '1' : '0.06';
                const rect = el.querySelector('rect, polygon, circle, ellipse');
                if (rect) {
                    if (id === nodeId) {
                        rect.style.stroke = '#1e293b';
                        rect.style.strokeWidth = '3px';
                    } else {
                        rect.style.stroke = '';
                        rect.style.strokeWidth = '';
                    }
                }
            });
            edgeElements.forEach((el, i) => {
                el.style.opacity = connectedEdgeIndices.has(i) ? '1' : '0';
            });
            document.querySelectorAll('.edgeLabel').forEach(el => {
                el.style.opacity = '0';
            });
        }

        function resetHighlight() {
            selectedNode = null;
            currentDoc = null;
            updateSidebarSelection(null);
            document.querySelectorAll('.node').forEach(el => {
                el.style.opacity = '1';
                const rect = el.querySelector('rect, polygon, circle, ellipse');
                if (rect) {
                    rect.style.stroke = '';
                    rect.style.strokeWidth = '';
                }
            });
            edgeElements.forEach(el => el.style.opacity = '1');
            document.querySelectorAll('.edgeLabel').forEach(el => el.style.opacity = '1');
        }

        mermaid.initialize({
            startOnLoad: false,
            theme: 'base',
            themeVariables: { background: '#ffffff', primaryColor: '#3b82f6', lineColor: '#94a3b8' },
            flowchart: { curve: 'basis', padding: 20 },
            securityLevel: 'loose',
        });

        async function renderGraph() {
            const def = buildMermaidDef();
            const { svg } = await mermaid.render('mermaid-graph', def);
            document.getElementById('graph').innerHTML = svg;
            indexEdges();
            document.querySelectorAll('.node').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    highlightNode(el.id.split('-')[1]);
                });
                el.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    const nodeId = el.id.split('-')[1];
                    const node = graphData.nodes.find(n => n.id === nodeId);
                    if (node) selectDoc(node.path);
                });
            });
            document.querySelector('.graph-container').addEventListener('click', (e) => {
                if (!e.target.closest('.node')) resetHighlight();
            });
        }

        buildFolderTree();
        buildLevelList();
        updateStats();
        renderGraph();
        function exportSVG() {
            const svg = document.querySelector('#graph svg');
            if (!svg) return;
            const svgData = new XMLSerializer().serializeToString(svg);
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'docsync-graph.svg';
            a.click();
            URL.revokeObjectURL(url);
        }

        const keyboardShortcuts = {
            'ArrowLeft': () => switchMainView('diagram'),
            'ArrowRight': () => switchMainView('editor'),
            'l': () => switchListView('levels'),
            't': () => switchListView('tree'),
        };

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            const action = keyboardShortcuts[e.key];
            if (action) {
                e.preventDefault();
                action();
            }
        });
    </script>
</body>
</html>
